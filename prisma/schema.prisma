generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Company {
  id              String      @id @default(uuid())
  name            String
  email           String      @unique
  phone           String?
  address         String?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  profileImageUrl String?
  cashShifts      CashShift[]
  customers       Customer[]
  orders          Order[]
  products        Product[]
  stores          Store[]
  users           User[]

  @@index([email])
}

model Store {
  id         String      @id @default(uuid())
  name       String
  address    String?
  phone      String?
  isActive   Boolean     @default(true)
  companyId  String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  cashShifts CashShift[]
  categories Category[]
  inventory  Inventory[]
  orders     Order[]
  products   Product[]
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users      User[]

  @@index([companyId])
}

model User {
  id          String           @id @default(uuid())
  email       String           @unique
  password    String
  firstName   String
  lastName    String
  phone       String?
  role        Role             @default(CASHIER)
  isActive    Boolean          @default(true)
  companyId   String?
  storeId     String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  cashShifts  CashShift[]
  orders      Order[]
  payments    Payment[]
  company     Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  store       Store?           @relation(fields: [storeId], references: [id])
  permissions UserPermission[]

  @@index([email])
  @@index([companyId])
  @@index([storeId])
}

model UserPermission {
  id         String     @id @default(uuid())
  userId     String
  permission Permission
  createdAt  DateTime   @default(now())
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@index([userId])
}

model Category {
  id        String    @id @default(uuid())
  name      String
  storeId   String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  store     Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products  Product[]

  @@unique([name, storeId])
  @@index([storeId])
}

model Product {
  id                 String           @id @default(uuid())
  name               String
  description        String?
  sku                String?          @unique
  isActive           Boolean          @default(true)
  storeId            String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  baseCost           Decimal?         @db.Decimal(10, 2)
  baseRetailPrice    Decimal          @db.Decimal(10, 2)
  baseWholesalePrice Decimal?         @db.Decimal(10, 2)
  categoryId         String?
  companyId          String
  mainImageUrl       String?
  taxPercent         Decimal          @default(0) @db.Decimal(5, 2)
  unit               String?          @default("pcs")
  orderItems         OrderItem[]
  category           Category?        @relation(fields: [categoryId], references: [id])
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  store              Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  variants           ProductVariant[]

  @@index([storeId])
  @@index([companyId])
  @@index([categoryId])
  @@index([sku])
  @@index([name])
}

model ProductVariant {
  id             String      @id @default(uuid())
  name           String
  sku            String?     @unique
  barcode        String?     @unique
  retailPrice    Decimal     @db.Decimal(10, 2)
  wholesalePrice Decimal?    @db.Decimal(10, 2)
  cost           Decimal?    @db.Decimal(10, 2)
  attributes     Json?
  productId      String
  isActive       Boolean     @default(true)
  imageUrl       String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  inventory      Inventory[]
  orderItems     OrderItem[]
  product        Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
  @@index([barcode])
  @@index([name])
}

model Inventory {
  id               String         @id @default(uuid())
  quantity         Int            @default(0)
  reorderLevel     Int            @default(10)
  productVariantId String
  storeId          String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  store            Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([productVariantId, storeId])
  @@index([productVariantId])
  @@index([storeId])
  @@index([quantity])
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  phone     String
  email     String?
  address   String?
  companyId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orders    Order[]

  @@unique([phone, companyId])
  @@index([companyId])
  @@index([phone])
  @@index([name])
}

model Order {
  id             String       @id @default(uuid())
  orderNumber    String       @unique
  status         OrderStatus  @default(DRAFT)
  subtotal       Decimal      @db.Decimal(10, 2)
  notes          String?
  storeId        String
  cashierId      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  cancelReason   String?
  cancelledAt    DateTime?
  cancelledBy    String?
  companyId      String
  customerName   String?
  customerPhone  String?
  customerType   CustomerType @default(RETAIL)
  discountAmount Decimal      @default(0) @db.Decimal(10, 2)
  shiftId        String?
  taxAmount      Decimal      @default(0) @db.Decimal(10, 2)
  totalAmount    Decimal      @db.Decimal(10, 2)
  customerId     String?
  parentOrderId  String?
  returnReason   String?
  type           OrderType    @default(SALE)
  voidedAt       DateTime?
  voidedBy       String?
  cashier        User         @relation(fields: [cashierId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer       Customer?    @relation(fields: [customerId], references: [id])
  parentOrder    Order?       @relation("OrderAdjustments", fields: [parentOrderId], references: [id])
  adjustments    Order[]      @relation("OrderAdjustments")
  cashShift      CashShift?   @relation(fields: [shiftId], references: [id])
  store          Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items          OrderItem[]
  payments       Payment[]

  @@index([companyId])
  @@index([storeId])
  @@index([cashierId])
  @@index([shiftId])
  @@index([customerId])
  @@index([orderNumber])
  @@index([customerType])
  @@index([status])
  @@index([type])
  @@index([parentOrderId])
  @@index([createdAt])
}

model OrderItem {
  id               String         @id @default(uuid())
  quantity         Float
  subtotal         Decimal        @db.Decimal(10, 2)
  orderId          String
  productId        String
  createdAt        DateTime       @default(now())
  discountAmount   Decimal        @default(0) @db.Decimal(10, 2)
  productName      String
  productVariantId String
  sku              String?
  taxAmount        Decimal        @default(0) @db.Decimal(10, 2)
  taxRate          Decimal        @default(0) @db.Decimal(5, 2)
  totalAmount      Decimal        @db.Decimal(10, 2)
  unitPrice        Decimal        @db.Decimal(10, 2)
  variantName      String
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product        @relation(fields: [productId], references: [id])
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productVariantId])
}

model Payment {
  id              String          @id @default(uuid())
  amount          Decimal         @db.Decimal(10, 2)
  method          PaymentMethod
  status          PaymentStatus   @default(INITIATED)
  notes           String?
  orderId         String
  processedBy     String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  shiftId         String?
  companyId       String
  currency        String          @default("BHD")
  customerRef     String?
  failureReason   String?
  provider        PaymentProvider @default(INTERNAL)
  providerData    Json?
  providerRef     String?         @unique
  refundReason    String?
  refundedAt      DateTime?
  refundedBy      String?
  storeId         String
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  processedByUser User            @relation(fields: [processedBy], references: [id])
  cashShift       CashShift?      @relation(fields: [shiftId], references: [id])

  @@index([orderId])
  @@index([companyId])
  @@index([storeId])
  @@index([processedBy])
  @@index([shiftId])
  @@index([method])
  @@index([status])
  @@index([provider])
  @@index([providerRef])
  @@index([createdAt])
}

model CashShift {
  id           String      @id @default(uuid())
  userId       String
  companyId    String
  storeId      String
  openingCash  Decimal     @db.Decimal(10, 2)
  closingCash  Decimal?    @db.Decimal(10, 2)
  expectedCash Decimal?    @db.Decimal(10, 2)
  difference   Decimal?    @db.Decimal(10, 2)
  openedAt     DateTime    @default(now())
  closedAt     DateTime?
  status       ShiftStatus @default(OPEN)
  openingNotes String?
  closingNotes String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  store        Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]
  payments     Payment[]

  @@index([userId])
  @@index([companyId])
  @@index([storeId])
  @@index([status])
  @@index([openedAt])
  @@index([closedAt])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  CASHIER
}

enum Permission {
  VIEW_DASHBOARD
  VIEW_REPORTS
  MANAGE_COMPANY
  MANAGE_SUBSCRIPTION
  MANAGE_STORES
  MANAGE_USERS
  MANAGE_PRODUCTS
  MANAGE_STOCK
  CREATE_ORDER
  PROCESS_PAYMENT
  PRINT_RECEIPT
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentProvider {
  INTERNAL
  TAP
}

enum OrderStatus {
  DRAFT
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum OrderType {
  SALE
  RETURN
  VOID
  ADJUSTMENT
}

enum CustomerType {
  RETAIL
  WHOLESALE
}

enum ShiftStatus {
  OPEN
  CLOSED
}
